<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Tipster Pro - Firebase Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCwAy4QfYlbxj4yBLnho3ZnO2_NaxzbVRQ",
            authDomain: "betmines-pronostici.firebaseapp.com",
            projectId: "betmines-pronostici",
            storageBucket: "betmines-pronostici.firebasestorage.app",
            messagingSenderId: "716119578109",
            appId: "1:716119578109:web:01e8b9dad7b17c91d63594"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.firebaseDB = db;
        window.firebaseCollection = collection;
        window.firebaseGetDocs = getDocs;
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .app-container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white; padding: 25px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 25px; text-align: center;
        }
        .header h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
        .header p { color: #666; font-size: 1.1em; }
        .card {
            background: white; border-radius: 15px; padding: 25px; margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); transition: transform 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
        .card-title {
            color: #333; font-size: 1.8em; margin-bottom: 20px; padding-bottom: 15px;
            border-bottom: 3px solid #667eea; font-weight: 700;
        }
        .stat-box-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; border-radius: 15px; text-align: center;
            transition: transform 0.3s ease;
        }
        .stat-box-card:hover { transform: translateY(-5px); }
        .stat-box-card h3 { font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; font-weight: 600; }
        .stat-box-card .stat-value { font-size: 2.5em; font-weight: bold; }
        .btn-primary, .btn-secondary, .btn-success, .btn-back, .btn-betfair, .btn-firebase {
            color: white; border: none; padding: 15px 30px; font-size: 1.1em; border-radius: 10px;
            cursor: pointer; transition: all 0.3s ease; font-weight: 600; display: inline-block;
            text-align: center; margin: 5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }
        .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6); }
        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6); }
        .btn-betfair {
            background: linear-gradient(135deg, #FFB800 0%, #FF8C00 100%);
            box-shadow: 0 4px 15px rgba(255, 184, 0, 0.4);
        }
        .btn-betfair:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 184, 0, 0.6); }
        .btn-firebase {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }
        .btn-firebase:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 53, 0.6); }
        .btn-back {
            background: linear-gradient(135deg, #757575 0%, #616161 100%);
            box-shadow: 0 4px 15px rgba(117, 117, 117, 0.4);
        }
        .btn-back:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(117, 117, 117, 0.6); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        input[type="date"], input[type="file"], select {
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;
            font-size: 1em; transition: border-color 0.3s ease; margin: 10px 0;
        }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        .table-container { overflow-x: auto; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 15px; text-align: left; font-weight: 600;
        }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f8f9ff; }
        .hidden { display: none; }
        .grid { display: grid; }
        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 1rem; }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .grid-cols-4 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        .alert-info {
            background: #e3f2fd; color: #1976d2; padding: 15px; border-radius: 8px;
            border-left: 4px solid #1976d2; margin: 15px 0; font-weight: 500;
        }
        .alert-success {
            background: #e8f5e9; color: #2e7d32; padding: 15px; border-radius: 8px;
            border-left: 4px solid #2e7d32; margin: 15px 0; font-weight: 500;
        }
        .alert-warning {
            background: #fff3e0; color: #e65100; padding: 15px; border-radius: 8px;
            border-left: 4px solid #e65100; margin: 15px 0; font-weight: 500;
        }
        .alert-betfair {
            background: #FFF8E1; color: #F57C00; padding: 15px; border-radius: 8px;
            border-left: 4px solid #FFB800; margin: 15px 0; font-weight: 500;
        }
        label { display: block; color: #555; font-weight: 600; margin-bottom: 8px; font-size: 1.1em; }
        .button-group { display: flex; gap: 15px; flex-wrap: wrap; margin: 20px 0; }
        .page { display: none; }
        .page.active { display: block; }
        #chartContainer { max-width: 900px; margin: 30px auto; }
        .score-badge {
            display: inline-block; padding: 8px 15px; border-radius: 20px;
            font-size: 1em; font-weight: 700; margin-left: 10px;
        }
        .score-excellent { background: #4CAF50; color: white; }
        .score-good { background: #8BC34A; color: white; }
        .score-medium { background: #FFC107; color: black; }
        .score-low { background: #FF9800; color: white; }
        .score-poor { background: #F44336; color: white; }
        .tip-badge {
            display: inline-block; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white; padding: 6px 12px; border-radius: 20px; margin: 3px;
            font-size: 0.9em; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .tips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .trading-card {
            background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
            border-left: 5px solid #FFB800; padding: 20px; margin: 15px 0;
            border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .strategy-badge {
            display: inline-block; background: #FFB800; color: white; padding: 5px 12px;
            border-radius: 15px; font-size: 0.85em; font-weight: 600; margin: 3px;
        }
        .ht-card {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-left: 5px solid #4CAF50; padding: 20px; margin: 15px 0;
            border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .loading-content {
            background: white; padding: 30px; border-radius: 15px; text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #667eea;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- PAGINA PRINCIPALE -->
        <div id="mainPage" class="page active">
            <div class="header">
                <h1>‚öΩ Sistema Tipster Pro</h1>
                <p>üî• Firebase Edition - Database Automatico</p>
            </div>
            
            <div class="card">
                <h2 class="card-title">üî• Database Firebase</h2>
                <div class="alert-info" id="firebase-status">
                    <strong>üì° Connessione Firebase:</strong> In attesa...
                </div>
                <div class="button-group">
                    <button class="btn-firebase" id="loadFirebaseBtn">üî• Carica da Firebase</button>
                    <button class="btn-primary" onclick="document.getElementById('dbFile').click()">üìÅ Carica CSV (Fallback)</button>
                    <input type="file" id="dbFile" accept=".csv" style="display: none;">
                </div>
                <div class="grid grid-cols-4" style="margin-top: 20px;">
                    <div class="stat-box-card"><h3>Partite nel Database</h3><div class="stat-value" id="total-matches">0</div></div>
                    <div class="stat-box-card"><h3>Vinte</h3><div class="stat-value" id="total-wins">0</div></div>
                    <div class="stat-box-card"><h3>Perse</h3><div class="stat-value" id="total-losses">0</div></div>
                    <div class="stat-box-card"><h3>Winrate</h3><div class="stat-value" id="total-winrate">0%</div></div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">üìÖ Tips del Giorno</h2>
                <div style="margin: 15px 0;">
                    <label for="date-input">1. Seleziona la Data</label>
                    <input type="date" id="date-input">
                </div>
                <div style="margin: 15px 0;">
                    <label>2. Carica Tips Principali</label>
                    <button class="btn-secondary" onclick="document.getElementById('tipsFile').click()" id="loadTipsBtn" disabled>‚ö° Carica Tips</button>
                    <input type="file" id="tipsFile" accept=".csv" style="display: none;">
                </div>
                <div style="margin: 15px 0;">
                    <label>3. Carica Tips HT Over 0.5 (Opzionale)</label>
                    <button class="btn-success" onclick="document.getElementById('htFile').click()" id="loadHTBtn" disabled>‚è±Ô∏è Carica HT</button>
                    <input type="file" id="htFile" accept=".csv" style="display: none;">
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">üîß Analisi</h2>
                <div class="button-group">
                    <button class="btn-primary" id="analyzeBtn" disabled>üìä Analisi Database</button>
                    <button class="btn-success" id="tradingBtn" disabled>üéØ Multiple</button>
                    <button class="btn-betfair" id="betfairBtn" disabled>üí∞ Betfair</button>
                    <button class="btn-secondary" id="checkResultsBtn" disabled>‚úÖ Risultati</button>
                </div>
            </div>
        </div>

        <!-- ALTRE PAGINE (uguali a prima) -->
        <div id="analysisPage" class="page">
            <div class="header"><h1>üìä Analisi Database</h1></div>
            <div class="card">
                <button class="btn-back" onclick="goToPage('mainPage')">‚Üê Torna al Menu</button>
                <div id="analysisContent"></div>
                <div id="chartContainer"><canvas id="analysisChart"></canvas></div>
            </div>
        </div>

        <div id="tradingPage" class="page">
            <div class="header"><h1>üéØ Multiple del Giorno</h1></div>
            <div class="card">
                <button class="btn-back" onclick="goToPage('mainPage')">‚Üê Torna al Menu</button>
                <div id="tradingContent"></div>
            </div>
        </div>

        <div id="betfairPage" class="page">
            <div class="header"><h1>üí∞ Strategie Betfair</h1></div>
            <div class="card">
                <button class="btn-back" onclick="goToPage('mainPage')">‚Üê Torna al Menu</button>
                <div id="betfairContent"></div>
            </div>
        </div>

        <div id="resultsPage" class="page">
            <div class="header"><h1>‚úÖ Risultati</h1></div>
            <div class="card">
                <button class="btn-back" onclick="goToPage('mainPage')">‚Üê Torna al Menu</button>
                <div style="margin: 20px 0;">
                    <label for="date-selector">Seleziona Data</label>
                    <select id="date-selector"></select>
                </div>
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2 style="color: #667eea; margin-bottom: 10px;">üî• Caricamento Firebase</h2>
            <p id="loadingText">Connessione in corso...</p>
        </div>
    </div>
       <script>
    let databaseData = [];
    let tipsData = [];
    let htData = [];
    let currentDate = '';
    let analysisChart = null;

    const dbFileInput = document.getElementById('dbFile');
    const tipsFileInput = document.getElementById('tipsFile');
    const htFileInput = document.getElementById('htFile');
    const dateInput = document.getElementById('date-input');
    const loadFirebaseBtn = document.getElementById('loadFirebaseBtn');
    const loadTipsBtn = document.getElementById('loadTipsBtn');
    const loadHTBtn = document.getElementById('loadHTBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const tradingBtn = document.getElementById('tradingBtn');
    const betfairBtn = document.getElementById('betfairBtn');
    const checkResultsBtn = document.getElementById('checkResultsBtn');

    dateInput.valueAsDate = new Date();
    currentDate = dateInput.value;

    // UTILITY FUNCTIONS
    const parseQuota = (quota) => {
        if (!quota) return 0;
        return parseFloat(quota.toString().replace(',', '.'));
    };

    const parseProbabilita = (prob) => {
        if (!prob) return 0;
        const cleaned = prob.toString().replace('%', '').trim();
        return parseInt(cleaned) || 0;
    };

    const getField = (obj, ...fieldNames) => {
        for (let name of fieldNames) {
            if (obj[name] !== undefined && obj[name] !== null && obj[name] !== '') {
                return obj[name];
            }
        }
        return '';
    };

    const formatDateItalian = (dateStr) => {
        const [year, month, day] = dateStr.split('-');
        const months = ['gennaio', 'febbraio', 'marzo', 'aprile', 'maggio', 'giugno', 
                       'luglio', 'agosto', 'settembre', 'ottobre', 'novembre', 'dicembre'];
        return `${parseInt(day)}-${months[parseInt(month) - 1]}`;
    };

    const goToPage = (pageId) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        window.scrollTo(0, 0);
    };

    const updateButtonStates = () => {
        loadTipsBtn.disabled = !databaseData.length || !currentDate;
        loadHTBtn.disabled = !databaseData.length || !currentDate;
        analyzeBtn.disabled = !databaseData.length;
        tradingBtn.disabled = !tipsData.length || !databaseData.length;
        betfairBtn.disabled = (!tipsData.length && !htData.length) || !databaseData.length;
        checkResultsBtn.disabled = !localStorage.getItem('tipsterDates');
    };

    const isBetfairLeague = (lega) => {
        if (!lega) return false;
        const leagueUpper = lega.toUpperCase();
        const europeanLeagues = ['ITA', 'SERIE', 'ESP', 'LIGA', 'ENG', 'PREMIER', 'CHAMPIONSHIP', 'GER', 'BUNDESLIGA', 
            'FRA', 'LIGUE', 'POR', 'LIGA PORTUGAL', 'NED', 'EREDIVISIE', 'GRC', 'TUR', 'SUI', 'BEL', 'SWE', 'NOR', 
            'DEN', 'SCO', 'AUT', 'CZE', 'POL', 'ROU', 'UKR', 'SRB', 'CRO'];
        const excludedRegions = ['BRA', 'ARG', 'CHI', 'PER', 'COL', 'USA', 'CAN', 'MEX', 'MLS', 'CHN', 'JPN', 'KOR', 
            'IND', 'AUS', 'EGY', 'MAR', 'SA-', 'AS-', 'NA-', 'AF-', 'OC-'];
        for (let excluded of excludedRegions) {
            if (leagueUpper.includes(excluded)) return false;
        }
        for (let european of europeanLeagues) {
            if (leagueUpper.includes(european)) return true;
        }
        return leagueUpper.startsWith('EU-');
    };

    // üî• CARICAMENTO FIREBASE
    loadFirebaseBtn.addEventListener('click', async () => {
        const overlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const statusDiv = document.getElementById('firebase-status');
        
        overlay.style.display = 'flex';
        loadingText.textContent = 'Connessione a Firebase...';
        
        try {
            if (!window.firebaseDB) {
                throw new Error('Firebase non inizializzato');
            }
            
            loadingText.textContent = 'Scaricamento partite...';
            
            const matchesCollection = window.firebaseCollection(window.firebaseDB, 'matches');
            const snapshot = await window.firebaseGetDocs(matchesCollection);
            
            loadingText.textContent = `Elaborazione ${snapshot.size} partite...`;
            
            databaseData = [];
            snapshot.forEach((doc) => {
                const data = doc.data();
                databaseData.push({
                    data: data.data || '',
                    lega: data.lega || '',
                    partita: data.partita || '',
                    risultato: data.risultato || '',
                    probabilita: data.probabilita || '',
                    mercato: data.mercato || '',
                    tip: data.tip || '',
                    quota: data.quota || '',
                    esito: data.esito || ''
                });
            });
            
            localStorage.setItem('cachedDatabase', JSON.stringify(databaseData));
            localStorage.setItem('cacheTimestamp', Date.now().toString());
            
            overlay.style.display = 'none';
            
            updateDatabaseStats();
            updateButtonStates();
            
            statusDiv.innerHTML = `<strong>‚úÖ Firebase Connesso!</strong><br>Caricati ${databaseData.length} match dall'archivio storico.<br><small>Cache locale salvata - prossimo caricamento sar√† istantaneo!</small>`;
            statusDiv.className = 'alert-success';
            
            loadFirebaseBtn.textContent = '‚úÖ Database Caricato';
            loadFirebaseBtn.disabled = true;
            
        } catch (error) {
            overlay.style.display = 'none';
            console.error('Errore Firebase:', error);
            statusDiv.innerHTML = `<strong>‚ùå Errore Firebase</strong><br>${error.message}<br><small>Usa il pulsante "Carica CSV" come fallback.</small>`;
            statusDiv.className = 'alert-warning';
        }
    });

    // üîÑ CARICA DA CACHE
    window.addEventListener('load', () => {
        const cached = localStorage.getItem('cachedDatabase');
        const cacheTime = localStorage.getItem('cacheTimestamp');
        const statusDiv = document.getElementById('firebase-status');
        
        if (cached && cacheTime) {
            const hoursSinceCache = (Date.now() - parseInt(cacheTime)) / (1000 * 60 * 60);
            
            if (hoursSinceCache < 24) {
                databaseData = JSON.parse(cached);
                updateDatabaseStats();
                updateButtonStates();
                
                statusDiv.innerHTML = `<strong>üíæ Database Caricato da Cache</strong><br>${databaseData.length} partite disponibili.<br><small>Ultima sincronizzazione: ${Math.round(hoursSinceCache)} ore fa. Clicca "Carica da Firebase" per aggiornare.</small>`;
                statusDiv.className = 'alert-info';
            } else {
                statusDiv.innerHTML = `<strong>‚ö†Ô∏è Cache Scaduta</strong><br>Clicca "Carica da Firebase" per aggiornare il database.`;
                statusDiv.className = 'alert-warning';
            }
        }
    });

    // CARICA CSV FALLBACK
    dbFileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: results => {
                databaseData = results.data;
                updateDatabaseStats();
                updateButtonStates();
                document.getElementById('firebase-status').innerHTML = `<strong>üìÅ Database CSV Caricato</strong><br>${databaseData.length} partite.`;
                document.getElementById('firebase-status').className = 'alert-success';
                alert(`‚úÖ CSV caricato: ${databaseData.length} partite`);
            }
        });
    });

    dateInput.addEventListener('change', e => {
        currentDate = e.target.value;
        updateButtonStates();
    });

    tipsFileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: results => {
                tipsData = results.data;
                saveTipsToCache(currentDate, tipsData);
                updateButtonStates();
                alert(`‚úÖ Tips caricati: ${tipsData.length} partite`);
            }
        });
    });

    htFileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: results => {
                htData = results.data;
                updateButtonStates();
                alert(`‚úÖ Tips HT caricati: ${htData.length} partite`);
            }
        });
    });

    const updateDatabaseStats = () => {
        const total = databaseData.length;
        const wins = databaseData.filter(r => r.esito === 'Vinto').length;
        const losses = databaseData.filter(r => r.esito === 'Perso').length;
        const winrate = total > 0 ? ((wins / total) * 100).toFixed(1) : 0;
        document.getElementById('total-matches').textContent = total;
        document.getElementById('total-wins').textContent = wins;
        document.getElementById('total-losses').textContent = losses;
        document.getElementById('total-winrate').textContent = winrate + '%';
    };

    const saveTipsToCache = (date, tips) => {
        const dates = JSON.parse(localStorage.getItem('tipsterDates') || '[]');
        if (!dates.includes(date)) {
            dates.push(date);
            localStorage.setItem('tipsterDates', JSON.stringify(dates));
        }
        localStorage.setItem(`tips_${date}`, JSON.stringify(tips));
        populateDateSelector();
    };

    const populateDateSelector = () => {
        const dates = JSON.parse(localStorage.getItem('tipsterDates') || '[]');
        const selector = document.getElementById('date-selector');
        selector.innerHTML = '<option value="">Seleziona una data</option>';
        dates.forEach(d => {
            const option = document.createElement('option');
            option.value = d;
            option.textContent = formatDateItalian(d);
            selector.appendChild(option);
        });
    };

    // ANALISI DATABASE
    analyzeBtn.addEventListener('click', () => {
        const leagueStats = {};
        databaseData.forEach(match => {
            const league = match.lega || 'Sconosciuta';
            const tip = match.tip || 'N/D';
            if (!leagueStats[league]) {
                leagueStats[league] = { total: 0, wins: 0, tips: {} };
            }
            leagueStats[league].total++;
            if (match.esito === 'Vinto') leagueStats[league].wins++;
            if (!leagueStats[league].tips[tip]) {
                leagueStats[league].tips[tip] = { total: 0, wins: 0 };
            }
            leagueStats[league].tips[tip].total++;
            if (match.esito === 'Vinto') leagueStats[league].tips[tip].wins++;
        });

        const qualifyingLeagues = [];
        Object.entries(leagueStats).forEach(([league, stats]) => {
            if (stats.total >= 20) {
                const winrate = (stats.wins / stats.total * 100);
                if (winrate > 85) {
                    const qualifyingTips = [];
                    Object.entries(stats.tips).forEach(([tip, tipStats]) => {
                        const tipWinrate = (tipStats.wins / tipStats.total * 100);
                        if (tipWinrate > 85) {
                            qualifyingTips.push({ text: `${tip}: ${tipStats.wins}/${tipStats.total} (${tipWinrate.toFixed(1)}%)` });
                        }
                    });
                    qualifyingLeagues.push({ league, winrate: winrate.toFixed(1), volume: stats.total, qualifyingTips });
                }
            }
        });

        qualifyingLeagues.sort((a, b) => parseFloat(b.winrate) - parseFloat(a.winrate));
        const top20 = qualifyingLeagues.slice(0, 20);

        let html = '<h3 style="font-size: 1.5em; margin: 20px 0; font-weight: 600;">üèÜ Top 20 Leghe Qualificate</h3>';
        html += '<div class="table-container"><table><thead><tr><th>Lega</th><th>Successo (%)</th><th>Volume</th><th>Tips Qualifying</th></tr></thead><tbody>';
        top20.forEach(l => {
            let tipsHtml = '';
            if (l.qualifyingTips.length > 0) {
                tipsHtml = '<div class="tips-container">';
                l.qualifyingTips.forEach(t => { tipsHtml += `<span class="tip-badge">${t.text}</span>`; });
                tipsHtml += '</div>';
            } else {
                tipsHtml = '<span style="color: #999;">Nessuna</span>';
            }
            html += `<tr><td><strong>${l.league}</strong></td><td>${l.winrate}%</td><td>${l.volume}</td><td>${tipsHtml}</td></tr>`;
        });
        html += '</tbody></table></div>';
        document.getElementById('analysisContent').innerHTML = html;

        if (analysisChart) analysisChart.destroy();
        const ctx = document.getElementById('analysisChart').getContext('2d');
        analysisChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: top20.map(l => l.league),
                datasets: [{ label: 'Winrate (%)', data: top20.map(l => parseFloat(l.winrate)), backgroundColor: 'rgba(102, 126, 234, 0.8)', borderColor: 'rgba(102, 126, 234, 1)', borderWidth: 2 }]
            },
            options: {
                indexAxis: 'y', responsive: true,
                plugins: { legend: { display: false }, title: { display: true, text: 'Top 20 Leghe per Winrate', font: { size: 18, weight: 'bold' } } },
                scales: { x: { beginAtZero: true, max: 100, title: { display: true, text: 'Winrate (%)' } } }
            }
        });
        goToPage('analysisPage');
    });

    // MULTIPLE DEL GIORNO - COMPLETO CON 2 DOPPIE
    tradingBtn.addEventListener('click', () => {
        const filteredTips = tipsData.filter(tip => {
            const prob = parseProbabilita(getField(tip, 'Probabilit√†', 'probabilita'));
            const quota = parseQuota(getField(tip, 'Quota', 'quota'));
            return prob >= 75 && quota >= 1.15 && quota <= 1.40;
        });

        if (filteredTips.length === 0) {
            document.getElementById('tradingContent').innerHTML = `<div class="alert-warning"><strong>‚ö†Ô∏è Nessuna partita trovata</strong></div>`;
            goToPage('tradingPage');
            return;
        }

        const enrichedTips = filteredTips.map(tip => {
            const league = getField(tip, 'Lega', 'lega');
            const tipType = getField(tip, 'Tip', 'tip');
            const partitaValue = getField(tip, 'Partita', 'partita');
            const [home, away] = partitaValue.split(' - ');
            
            const probBetMines = parseProbabilita(getField(tip, 'Probabilit√†', 'probabilita'));
            const quota = parseQuota(getField(tip, 'Quota', 'quota'));
            
            let finalScore = probBetMines;
            let boostFactors = [];
            
            const leagueHistory = databaseData.filter(m => m.lega === league && m.tip === tipType);
            if (leagueHistory.length >= 5) {
                const leagueWins = leagueHistory.filter(m => m.esito === 'Vinto').length;
                const leagueWinrate = (leagueWins / leagueHistory.length * 100);
                
                if (leagueWinrate >= 90) {
                    finalScore += 10;
                    boostFactors.push(`‚úÖ Storico lega: ${leagueWinrate.toFixed(0)}% (${leagueWins}/${leagueHistory.length})`);
                } else if (leagueWinrate >= 80) {
                    finalScore += 5;
                    boostFactors.push(`‚úì Storico lega: ${leagueWinrate.toFixed(0)}% (${leagueWins}/${leagueHistory.length})`);
                } else if (leagueWinrate >= 70) {
                    finalScore += 2;
                    boostFactors.push(`Storico lega: ${leagueWinrate.toFixed(0)}% (${leagueWins}/${leagueHistory.length})`);
                }
            }
            
            if (tipType && (tipType.includes('1.5') || tipType.includes('2.5') || tipType.includes('3.5'))) {
                const allHomeMatches = databaseData.filter(m => (m.partita || '').split(' - ')[0] === home);
                const allAwayMatches = databaseData.filter(m => (m.partita || '').split(' - ')[1] === away);
                
                if (allHomeMatches.length >= 5 && allAwayMatches.length >= 5) {
                    const homeGoals = allHomeMatches.map(m => {
                        const res = (m.risultato || '').split(' - ');
                        return parseInt(res[0] || 0);
                    });
                    const avgHome = homeGoals.reduce((a, b) => a + b, 0) / homeGoals.length;
                    
                    const awayGoalsConceded = allAwayMatches.map(m => {
                        const res = (m.risultato || '').split(' - ');
                        return parseInt(res[0] || 0);
                    });
                    const avgAwayConceded = awayGoalsConceded.reduce((a, b) => a + b, 0) / awayGoalsConceded.length;
                    
                    let supportBonus = 0;
                    if (tipType.includes('+1.5') && avgHome >= 1.5 && avgAwayConceded >= 1.3) {
                        supportBonus = 5;
                        boostFactors.push(`‚úÖ Gol favorevoli: Casa ${avgHome.toFixed(1)} | Trasf. ${avgAwayConceded.toFixed(1)}`);
                    } else if (tipType.includes('+2.5') && avgHome >= 2.0 && avgAwayConceded >= 1.8) {
                        supportBonus = 5;
                        boostFactors.push(`‚úÖ Gol favorevoli: Casa ${avgHome.toFixed(1)} | Trasf. ${avgAwayConceded.toFixed(1)}`);
                    } else if (tipType.includes('-3.5') && avgHome <= 2.0 && avgAwayConceded <= 2.0) {
                        supportBonus = 5;
                        boostFactors.push(`‚úÖ Gol favorevoli: Casa ${avgHome.toFixed(1)} | Trasf. ${avgAwayConceded.toFixed(1)}`);
                    }
                    finalScore += supportBonus;
                }
            }
            
            const allHomeMatches = databaseData.filter(m => (m.partita || '').split(' - ')[0] === home);
            const allAwayMatches = databaseData.filter(m => (m.partita || '').split(' - ')[1] === away);
            const recentHome = allHomeMatches.slice(-5);
            const recentAway = allAwayMatches.slice(-5);
            
            if (recentHome.length >= 3 && recentAway.length >= 3) {
                const homeWins = recentHome.filter(m => m.esito === 'Vinto').length;
                const awayWins = recentAway.filter(m => m.esito === 'Vinto').length;
                const formaMedia = ((homeWins / recentHome.length) + (awayWins / recentAway.length)) / 2 * 100;
                
                if (formaMedia >= 70) {
                    finalScore += 3;
                    boostFactors.push(`Forma: Casa ${homeWins}/${recentHome.length} | Trasf. ${awayWins}/${recentAway.length}`);
                }
            }
            
            finalScore = Math.min(finalScore, 100);
            
            if (boostFactors.length === 0) {
                boostFactors.push('üìä Basato su probabilit√† BetMines');
            }
            
            return {
                partita: partitaValue,
                lega: league,
                tip: tipType,
                probabilita: probBetMines,
                quota: quota,
                finalScore: finalScore,
                boostFactors: boostFactors
            };
        });

        enrichedTips.sort((a, b) => b.finalScore - a.finalScore);

        let html = '<div class="alert-info"><strong>üéØ Strategia:</strong> Score basato su probabilit√† BetMines + bonus storico. Doppie con quote ‚â•1.20.</div>';

        // TRIPLA
        const triplaLeagues = [...new Set(enrichedTips.map(t => t.lega))];
        const tripla = [];
        triplaLeagues.forEach(league => {
            if (tripla.length < 3) {
                const best = enrichedTips.find(t => t.lega === league && t.finalScore >= 78 && t.quota >= 1.15 && !tripla.includes(t));
                if (best) tripla.push(best);
            }
        });

        if (tripla.length === 3) {
            const quotaTripla = tripla.reduce((acc, t) => acc * t.quota, 1);
            html += '<h3 style="font-size: 1.6em; margin: 30px 0 20px 0; font-weight: 600;">üî• TRIPLA PREMIUM</h3>';
            html += '<div class="table-container"><table><thead><tr><th>Partita</th><th>Lega</th><th>Tip</th><th>Prob</th><th>Score</th><th>Quota</th></tr></thead><tbody>';
            tripla.forEach((t, idx) => {
                let scoreClass = t.finalScore >= 90 ? 'score-excellent' : t.finalScore >= 85 ? 'score-good' : t.finalScore >= 80 ? 'score-medium' : 'score-low';
                html += `<tr>
                    <td><strong>${idx + 1}. ${t.partita}</strong></td>
                    <td><small style="color: #666;">${t.lega}</small></td>
                    <td><strong>${t.tip}</strong></td>
                    <td>${t.probabilita}%</td>
                    <td><span class="score-badge ${scoreClass}">${t.finalScore.toFixed(0)}/100</span></td>
                    <td><strong>${t.quota.toFixed(2)}</strong></td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            
            html += '<div class="alert-success" style="font-size: 1.1em;">';
            html += `<strong>üìä Riepilogo Tripla:</strong><br>`;
            html += `‚Ä¢ <strong>Quota Totale:</strong> ${quotaTripla.toFixed(2)}<br>`;
            html += `‚Ä¢ <strong>Puntata Consigliata:</strong> ‚Ç¨30,00<br>`;
            html += `‚Ä¢ <strong>Ritorno Potenziale:</strong> ‚Ç¨${(30 * quotaTripla).toFixed(2)}<br>`;
            html += `‚Ä¢ <strong>Profit Netto:</strong> ‚Ç¨${(30 * (quotaTripla - 1)).toFixed(2)}<br><br>`;
            html += `<strong>üéØ Perch√© questa tripla:</strong><br>`;
            tripla.forEach((t, idx) => {
                html += `${idx + 1}. <strong>${t.partita}</strong> (${t.lega}): ${t.boostFactors.join(' | ')}<br>`;
            });
            html += '</div>';
        }

        // DOPPIA 1 (quote ‚â•1.20)
        const doppia1Candidates = enrichedTips.filter(t => t.finalScore >= 85 && t.probabilita >= 82 && t.quota >= 1.20);
        let doppia1 = [];
        if (doppia1Candidates.length >= 2) {
            const leagues1 = [...new Set(doppia1Candidates.map(t => t.lega))];
            leagues1.slice(0, 2).forEach(league => {
                const best = doppia1Candidates.find(t => t.lega === league);
                if (best && doppia1.length < 2) doppia1.push(best);
            });
        }

        if (doppia1.length === 2) {
            const quotaDoppia1 = doppia1.reduce((acc, t) => acc * t.quota, 1);
            html += '<h3 style="font-size: 1.5em; margin: 30px 0 20px 0; font-weight: 600;">üõ°Ô∏è DOPPIA 1: Massima Sicurezza (Quote ‚â•1.20)</h3>';
            html += '<div class="table-container"><table><thead><tr><th>Partita</th><th>Lega</th><th>Tip</th><th>Prob</th><th>Score</th><th>Quota</th></tr></thead><tbody>';
            doppia1.forEach((t, idx) => {
                html += `<tr>
                    <td><strong>${idx + 1}. ${t.partita}</strong></td>
                    <td><small style="color: #666;">${t.lega}</small></td>
                    <td>${t.tip}</td>
                    <td>${t.probabilita}%</td>
                    <td><span class="score-badge score-excellent">${t.finalScore.toFixed(0)}/100</span></td>
                    <td><strong>${t.quota.toFixed(2)}</strong></td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            html += `<div class="alert-success"><strong>Quota:</strong> ${quotaDoppia1.toFixed(2)} | <strong>Puntata:</strong> ‚Ç¨50 | <strong>Ritorno:</strong> ‚Ç¨${(50 * quotaDoppia1).toFixed(2)} | <strong>Profit:</strong> ‚Ç¨${(50 * (quotaDoppia1 - 1)).toFixed(2)}<br><br>`;
            html += `<strong>üí™ Perch√© sicura:</strong> Entrambe hanno score ‚â•85/100, probabilit√† BetMines ‚â•82% e quote ‚â•1.20.</div>`;
        }

        // DOPPIA 2 (quote ‚â•1.20)
        const doppia2Candidates = enrichedTips.filter(t => 
            t.finalScore >= 78 && 
            t.finalScore < 85 && 
            t.quota >= 1.20 &&
            !doppia1.includes(t) && 
            !tripla.includes(t)
        );
        let doppia2 = [];
        if (doppia2Candidates.length >= 2) {
            const leagues2 = [...new Set(doppia2Candidates.map(t => t.lega))];
            leagues2.slice(0, 2).forEach(league => {
                const best = doppia2Candidates.find(t => t.lega === league);
                if (best && doppia2.length < 2) doppia2.push(best);
            });
        }

        if (doppia2.length === 2) {
            const quotaDoppia2 = doppia2.reduce((acc, t) => acc * t.quota, 1);
            html += '<h3 style="font-size: 1.5em; margin: 30px 0 20px 0; font-weight: 600;">‚öñÔ∏è DOPPIA 2: Quota Equilibrata (Quote ‚â•1.20)</h3>';
            html += '<div class="table-container"><table><thead><tr><th>Partita</th><th>Lega</th><th>Tip</th><th>Prob</th><th>Score</th><th>Quota</th></tr></thead><tbody>';
            doppia2.forEach((t, idx) => {
                let scoreClass = t.finalScore >= 82 ? 'score-good' : 'score-medium';
                html += `<tr>
                    <td><strong>${idx + 1}. ${t.partita}</strong></td>
                    <td><small style="color: #666;">${t.lega}</small></td>
                    <td>${t.tip}</td>
                    <td>${t.probabilita}%</td>
                    <td><span class="score-badge ${scoreClass}">${t.finalScore.toFixed(0)}/100</span></td>
                    <td><strong>${t.quota.toFixed(2)}</strong></td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            html += `<div class="alert-info"><strong>Quota:</strong> ${quotaDoppia2.toFixed(2)} | <strong>Puntata:</strong> ‚Ç¨40 | <strong>Ritorno:</strong> ‚Ç¨${(40 * quotaDoppia2).toFixed(2)} | <strong>Profit:</strong> ‚Ç¨${(40 * (quotaDoppia2 - 1)).toFixed(2)}<br><br>`;
            html += `<strong>üìà Perch√© interessante:</strong> Buon rapporto rischio/rendimento con score 78-84/100 e quote equilibrate ‚â•1.20.</div>`;
        }

        if (tripla.length < 3 && doppia1.length < 2 && doppia2.length < 2) {
            html += '<div class="alert-warning"><strong>‚ö†Ô∏è Poche partite qualificate</strong><br>Doppie richiedono quote ‚â•1.20. Prova ad abbassare filtro probabilit√†.</div>';
        }

        document.getElementById('tradingContent').innerHTML = html;
        goToPage('tradingPage');
    });

    // BETFAIR COMPLETO - HT + LAY THE DRAW
    betfairBtn.addEventListener('click', () => {
        let html = '';
        let europeanCount = 0;
        let excludedCount = 0;

        // === HT OVER 0.5 ===
        if (htData.length > 0) {
            const htFiltered = htData.filter(t => {
                const lega = getField(t, 'Lega', 'lega');
                const prob = parseProbabilita(getField(t, 'Probabilit√†', 'probabilita', 'Probabilita'));
                const quota = parseQuota(getField(t, 'Quota', 'quota'));
                
                if (!isBetfairLeague(lega)) {
                    excludedCount++;
                    return false;
                }
                
                if (prob >= 75 && quota >= 1.20 && quota <= 1.50) {
                    europeanCount++;
                    return true;
                }
                return false;
            }).slice(0, 5);

            if (htFiltered.length > 0) {
                html += '<h3 style="font-size: 1.5em; margin: 30px 0 20px 0; font-weight: 600;">‚è±Ô∏è HT Over 0.5 - Leghe Europee (Alta Liquidit√†)</h3>';
                html += '<div class="alert-success"><strong>üíé Solo campionati europei</strong> giocati tra 14:00-23:00 CET con alta liquidit√† su Betfair Italia.</div>';
                
                htFiltered.forEach(t => {
                    const prob = parseProbabilita(getField(t, 'Probabilit√†', 'probabilita', 'Probabilita'));
                    const quota = parseQuota(getField(t, 'Quota', 'quota'));
                    const partita = getField(t, 'Partita', 'partita');
                    const lega = getField(t, 'Lega', 'lega');
                    
                    html += `<div class="ht-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <strong style="font-size: 1.3em;">${partita}</strong><br>
                                <small style="color: #666;">üìç ${lega}</small>
                            </div>
                            <span class="strategy-badge" style="background: #4CAF50;">HT OVER 0.5</span>
                        </div>
                        <p><strong>Prob:</strong> ${prob}% | <strong>Quota Prematch:</strong> ${quota.toFixed(2)}</p>
                        <div class="alert-betfair" style="margin-top: 15px; background: #E8F5E9; border-left-color: #4CAF50;">
                            <strong>üìä Piano di Trading:</strong><br>
                            ‚Ä¢ <strong>Entrata:</strong> SUBITO all'inizio o entro 5¬∞ minuto<br>
                            ‚Ä¢ <strong>Quota entrata ideale:</strong> ${(quota - 0.05).toFixed(2)}-${quota.toFixed(2)}<br>
                            ‚Ä¢ <strong>Target:</strong> Al 1¬∞ gol HT ‚Üí quota scende a ~1.05 ‚Üí <strong>GREEN ${((quota / 1.05 - 1) * 100).toFixed(0)}%</strong><br>
                            ‚Ä¢ <strong>Stop Loss:</strong> Se al 40¬∞ minuto ancora 0-0 ‚Üí chiudi posizione (-50%)<br>
                            ‚Ä¢ <strong>Stake consigliata:</strong> ‚Ç¨50-100 (basso rischio, alta probabilit√†)<br>
                            ‚Ä¢ <strong>Profit atteso:</strong> ‚Ç¨${(50 * (quota / 1.05 - 1)).toFixed(0)}-${(100 * (quota / 1.05 - 1)).toFixed(0)} in ~20-30 minuti
                        </div>
                    </div>`;
                });

                // Multipla HT
                if (htFiltered.length >= 3) {
                    const topHT = htFiltered.slice(0, 3);
                    const quotaMulti = topHT.reduce((acc, t) => acc * parseQuota(getField(t, 'Quota', 'quota')), 1);
                    html += '<h3 style="font-size: 1.4em; margin: 20px 0 15px 0; font-weight: 600;">üöÄ Multipla HT (3 partite)</h3>';
                    html += '<div class="ht-card">';
                    html += '<div class="table-container"><table><thead><tr><th>Partita</th><th>Lega</th><th>Prob</th><th>Quota</th></tr></thead><tbody>';
                    topHT.forEach(t => {
                        html += `<tr><td>${getField(t, 'Partita', 'partita')}</td><td><small>${getField(t, 'Lega', 'lega')}</small></td><td>${parseProbabilita(getField(t, 'Probabilit√†', 'probabilita', 'Probabilita'))}%</td><td>${parseQuota(getField(t, 'Quota', 'quota')).toFixed(2)}</td></tr>`;
                    });
                    html += '</tbody></table></div>';
                    html += `<div class="alert-success" style="margin-top: 15px;"><strong>Quota Totale:</strong> ${quotaMulti.toFixed(2)} | <strong>Puntata:</strong> ‚Ç¨30 | <strong>Ritorno:</strong> ‚Ç¨${(30 * quotaMulti).toFixed(2)} | <strong>Profit:</strong> ‚Ç¨${(30 * (quotaMulti - 1)).toFixed(2)}</div>`;
                    html += '</div>';
                }
            }
        }

        // === LAY THE DRAW ===
        if (tipsData.length > 0) {
            const layDrawCandidates = tipsData.filter(t => {
                const lega = getField(t, 'Lega', 'lega');
                const tip = getField(t, 'Tip', 'tip');
                const prob = parseProbabilita(getField(t, 'Probabilit√†', 'probabilita'));
                const quota = parseQuota(getField(t, 'Quota', 'quota'));
                
                if (!isBetfairLeague(lega)) {
                    excludedCount++;
                    return false;
                }
                
                if (tip === '12' && prob >= 75 && quota >= 1.20 && quota <= 1.35) {
                    europeanCount++;
                    return true;
                }
                return false;
            }).slice(0, 3);

            if (layDrawCandidates.length > 0) {
                html += '<h3 style="font-size: 1.5em; margin: 30px 0 20px 0; font-weight: 600;">üéØ Lay the Draw - Leghe Europee</h3>';
                layDrawCandidates.forEach(t => {
                    const partita = getField(t, 'Partita', 'partita');
                    const lega = getField(t, 'Lega', 'lega');
                    const [home, away] = partita.split(' - ');
                    
                    // Analisi squadre per Lay the Draw
                    const allHomeMatches = databaseData.filter(m => (m.partita || '').split(' - ')[0] === home);
                    const allAwayMatches = databaseData.filter(m => (m.partita || '').split(' - ')[1] === away);
                    const recentHome = allHomeMatches.slice(-5);
                    const recentAway = allAwayMatches.slice(-5);
                    
                    let teamInfo = '';
                    if (recentHome.length >= 3 && recentAway.length >= 3) {
                        const homeWins = recentHome.filter(m => m.esito === 'Vinto').length;
                        const awayWins = recentAway.filter(m => m.esito === 'Vinto').length;
                        teamInfo = `Forma recente: Casa ${homeWins}/${recentHome.length} | Trasferta ${awayWins}/${recentAway.length}`;
                    }
                    
                    html += `<div class="trading-card">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <div>
                                <strong style="font-size: 1.2em;">${partita}</strong><br>
                                <small style="color: #666;">üìç ${lega}</small>
                            </div>
                            <span class="strategy-badge">LAY DRAW</span>
                        </div>
                        ${teamInfo ? `<p style="color: #666; margin-bottom: 10px;">${teamInfo}</p>` : ''}
                        <div class="alert-betfair">
                            <strong>üìä Strategia Lay the Draw:</strong><br>
                            ‚Ä¢ <strong>Entrata:</strong> 10-15¬∞ minuto (osserva pressing e occasioni)<br>
                            ‚Ä¢ <strong>Quota Draw da layare:</strong> 3.00-4.50 (ideale 3.50)<br>
                            ‚Ä¢ <strong>Uscita GREEN:</strong> Al 1¬∞ gol ‚Üí quota Draw sale ‚Üí chiudi posizione<br>
                            ‚Ä¢ <strong>Stop Loss:</strong> 70¬∞ minuto se ancora 0-0 (-50% responsabilit√†)<br>
                            ‚Ä¢ <strong>Target Green:</strong> 30-50% della responsabilit√†<br>
                            ‚Ä¢ <strong>Stake consigliata:</strong> ‚Ç¨100 responsabilit√† (profit ‚Ç¨30-50 se gol)<br>
                            ‚Ä¢ <strong>‚ö†Ô∏è Attenzione:</strong> Evita partite difensive o con troppe occasioni sprecate
                        </div>
                    </div>`;
                });
            }
        }

        if (html === '') {
            html = '<div class="alert-warning"><strong>‚ö†Ô∏è Nessuna partita europea trovata</strong><br>Carica file HT/Tips. Partite escluse (campionati extra-UE/notturni): ' + excludedCount + '</div>';
        } else {
            html = `<div class="alert-info"><strong>üåç Filtro Betfair Attivo:</strong> Selezionate ${europeanCount} partite europee su ${europeanCount + excludedCount} totali. Escluse ${excludedCount} partite (orari notturni/bassa liquidit√†).</div>` + html;
        }

        document.getElementById('betfairContent').innerHTML = html;
        goToPage('betfairPage');
    });

    // RISULTATI
    checkResultsBtn.addEventListener('click', () => goToPage('resultsPage'));
    document.getElementById('date-selector').addEventListener('change', e => {
        const selectedDate = e.target.value;
        if (!selectedDate) return;
        const checkedResults = databaseData.filter(m => m.data === selectedDate);
        const wins = checkedResults.filter(r => r.esito === 'Vinto').length;
        const losses = checkedResults.filter(r => r.esito === 'Perso').length;
        const winrate = wins + losses > 0 ? ((wins / (wins + losses)) * 100).toFixed(1) : 0;
        let html = `<h3 style="font-size: 1.5em; margin: 20px 0; text-align: center; font-weight: 600;">Risultati ${formatDateItalian(selectedDate)}</h3>`;
        html += `<div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 30px;">
            <div style="padding: 20px; background: #e8f5e9; color: #2e7d32; border-radius: 10px; text-align: center;"><strong style="display: block; font-size: 1.2em;">Vinte</strong><span style="font-size: 2em; font-weight: bold;">${wins}</span></div>
            <div style="padding: 20px; background: #ffebee; color: #c62828; border-radius: 10px; text-align: center;"><strong style="display: block; font-size: 1.2em;">Perse</strong><span style="font-size: 2em; font-weight: bold;">${losses}</span></div>
            <div style="padding: 20px; background: #e3f2fd; color: #1565c0; border-radius: 10px; text-align: center;"><strong style="display: block; font-size: 1.2em;">Winrate</strong><span style="font-size: 2em; font-weight: bold;">${winrate}%</span></div>
        </div>`;
        html += '<div class="table-container"><table><thead><tr><th>Partita</th><th>Tip</th><th>Quota</th><th>Esito</th></tr></thead><tbody>';
        checkedResults.forEach(r => {
            const color = r.esito === 'Vinto' ? 'color: #2e7d32; font-weight: 600;' : 'color: #c62828; font-weight: 600;';
            html += `<tr><td>${r.partita}</td><td>${r.tip}</td><td>${r.quota}</td><td style="${color}">${r.esito}</td></tr>`;
        });
        html += '</tbody></table></div>';
        document.getElementById('resultsContent').innerHTML = html;
    });

    updateButtonStates();
    populateDateSelector();
    </script>
</body>
</html>
